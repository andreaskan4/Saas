@page "/register"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@using LabPortal.Client.Providers
@using Microsoft.AspNetCore.Components.Authorization
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<h3>Εγγραφή Νέου Χρήστη</h3>

<div style="max-width: 400px; margin: auto;">

    <div class="mb-3">
        <label>Email</label>
        <input @bind="registerModel.Email" class="form-control" placeholder="user@example.com" />
    </div>
    <div class="mb-3">
        <label>Password</label>
        <input @bind="registerModel.Password" type="password" class="form-control" placeholder="Π.χ. Pass123!" />
        <small class="text-muted" style="font-size: 0.8rem;">
            Απαιτείται: 1 Κεφαλαίο, 1 Μικρό, 1 Αριθμός, 1 Σύμβολο
        </small>
    </div>

    <button class="btn btn-primary w-100" @onclick="HandleRegister">Εγγραφή</button>

    <div class="text-center my-3">
        <span class="text-muted">--- Ή ---</span>
    </div>

    <div id="google-btn"></div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">
            <strong>Προέκυψε σφάλμα:</strong> <br />
            @errorMessage
        </div>
    }

    <div class="mt-3 text-center">
        <small>Έχεις ήδη λογαριασμό; <a href="login">Σύνδεση εδώ</a></small>
    </div>
</div>

@code {
    private RegisterDto registerModel = new RegisterDto();
    private string errorMessage = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var clientId = "556583745456-5f8tch4j4329g11qvqce67srbiklvi2v.apps.googleusercontent.com";
                await JS.InvokeVoidAsync("initializeGoogleSignIn", clientId, DotNetObjectReference.Create(this));
            }
            catch (Exception ex)
            {
                Console.WriteLine("Google Init Error: " + ex.Message);
            }
        }
    }

    [JSInvokable]
    public async Task HandleGoogleLogin(string googleIdToken)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/account/google-login", new { IdToken = googleIdToken });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsAuthenticated(result.AccessToken);
                Navigation.NavigateTo("/chat");
            }
            else
            {
                errorMessage = "Αποτυχία εγγραφής/σύνδεσης με Google.";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Σφάλμα: " + ex.Message;
            StateHasChanged();
        }
    }

    private async Task HandleRegister()
    {
        errorMessage = "";

        var response = await Http.PostAsJsonAsync("/identity/register", registerModel);

        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/login");
        }
        else
        {
            var errorBody = await response.Content.ReadAsStringAsync();

            if (errorBody.Contains("PasswordRequiresNonAlphanumeric"))
                errorMessage = "Ο κωδικός χρειάζεται τουλάχιστον ένα σύμβολο (π.χ. !@#).";
            else if (errorBody.Contains("PasswordRequiresDigit"))
                errorMessage = "Ο κωδικός χρειάζεται τουλάχιστον έναν αριθμό.";
            else if (errorBody.Contains("PasswordRequiresUpper"))
                errorMessage = "Ο κωδικός χρειάζεται τουλάχιστον ένα κεφαλαίο γράμμα.";
            else if (errorBody.Contains("DuplicateUserName"))
                errorMessage = "Αυτό το email χρησιμοποιείται ήδη.";
            else
                errorMessage = "Κάτι πήγε στραβά. Ελέγξτε τα στοιχεία σας.";
        }
    }

    public class RegisterDto
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }

    public class LoginResponse
    {
        [JsonPropertyName("accessToken")]
        public string AccessToken { get; set; } = "";
    }
}
